{% extends "dashboard/base.html" %}

{% block title %}Dashboard - Industrial Boiler Monitoring Platform{% endblock %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-fire"></i> 
            <span class="d-none d-sm-inline">Industrial Boiler Monitor</span>
            <span class="d-inline d-sm-none">Boiler Monitor</span>
            <small class="badge bg-warning text-dark ms-2">DEMO</small>
        </a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-2 me-md-3 d-none d-sm-inline">Welcome, {{ user.username }}</span>
            <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">
                <i class="fas fa-sign-out-alt"></i> 
                <span class="d-none d-md-inline">Logout</span>
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid mt-2 mt-md-4">
    <!-- System Overview Cards -->
    <div class="row mb-3 mb-md-4 g-2 g-md-3">
        <div class="col-6 col-md-3">
            <div class="card metric-card">
                <div class="card-body text-center py-2 py-md-3">
                    <i class="fas fa-fire fa-lg fa-md-2x mb-1 mb-md-2"></i>
                    <h5 class="mb-0" id="total-boilers">-</h5>
                    <small class="d-block">Total Boilers</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center py-2 py-md-3">
                    <i class="fas fa-check-circle fa-lg fa-md-2x mb-1 mb-md-2"></i>
                    <h5 class="mb-0" id="operational-boilers">-</h5>
                    <small class="d-block">Operational</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center py-2 py-md-3">
                    <i class="fas fa-exclamation-triangle fa-lg fa-md-2x mb-1 mb-md-2"></i>
                    <h5 class="mb-0" id="warning-boilers">-</h5>
                    <small class="d-block">Warnings</small>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center py-2 py-md-3">
                    <i class="fas fa-chart-line fa-lg fa-md-2x mb-1 mb-md-2"></i>
                    <h5 class="mb-0" id="avg-efficiency">-%</h5>
                    <small class="d-block">Avg Efficiency</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Monitoring - Responsive Layout -->
    <div class="row g-2 g-md-3">
        <div class="col-12 col-lg-8 order-1 order-lg-1">
            <div class="card mb-3 mb-lg-0">
                <div class="card-header">
                    <h5 class="card-title mb-0 h6 h-md-5">
                        <i class="fas fa-thermometer-half"></i> 
                        <span class="d-none d-sm-inline">Real-time Temperature Monitoring</span>
                        <span class="d-inline d-sm-none">Temperature</span>
                    </h5>
                </div>
                <div class="card-body p-2 p-md-3">
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-lg-4 order-2 order-lg-2">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0 h6 h-md-5">
                        <i class="fas fa-bell"></i> Active Alerts
                    </h5>
                </div>
                <div class="card-body p-2 p-md-3">
                    <div id="alerts-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading alerts...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Boiler Status Table -->
    <div class="row mt-3 mt-md-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0 h6 h-md-5">
                        <i class="fas fa-list"></i> 
                        <span class="d-none d-sm-inline">Boiler Status Overview</span>
                        <span class="d-inline d-sm-none">Status</span>
                    </h5>
                </div>
                <div class="card-body p-2 p-md-3">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm table-md-normal mb-0">
                            <thead>
                                <tr>
                                    <th class="text-nowrap">Boiler</th>
                                    <th class="text-nowrap">Status</th>
                                    <th class="text-nowrap d-none d-sm-table-cell">Temp (°C)</th>
                                    <th class="text-nowrap d-none d-md-table-cell">Pressure</th>
                                    <th class="text-nowrap d-none d-lg-table-cell">Flow Rate</th>
                                    <th class="text-nowrap d-none d-sm-table-cell">Efficiency</th>
                                    <th class="text-nowrap d-none d-md-table-cell">Maintenance</th>
                                </tr>
                            </thead>
                            <tbody id="boiler-status-table">
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading boiler data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let temperatureChart;

function initializeChart() {
    const ctx = document.getElementById('temperatureChart').getContext('2d');
    temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Boiler 1',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Boiler 2', 
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Boiler 3',
                    data: [],
                    borderColor: 'rgb(255, 205, 86)',
                    backgroundColor: 'rgba(255, 205, 86, 0.1)', 
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 150,
                    max: 250,
                    title: {
                        display: true,
                        text: 'Temperature (°C)',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    },
                    ticks: {
                        font: {
                            size: window.innerWidth < 768 ? 9 : 11
                        }
                    }
                },
                x: {
                    title: {
                        display: window.innerWidth >= 768,
                        text: 'Time',
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        }
                    },
                    ticks: {
                        font: {
                            size: window.innerWidth < 768 ? 9 : 11
                        },
                        maxTicksLimit: window.innerWidth < 768 ? 6 : 12
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            size: window.innerWidth < 768 ? 10 : 12
                        },
                        padding: window.innerWidth < 768 ? 10 : 20,
                        usePointStyle: true
                    }
                },
                title: {
                    display: window.innerWidth >= 768,
                    text: 'Temperature Trends - Last 24 Hours',
                    font: {
                        size: window.innerWidth < 768 ? 12 : 14
                    }
                }
            }
        }
    });
}

function updateDashboard() {
    fetch('/api/sensor-data/')
        .then(response => response.json())
        .then(data => {
            // Update overview cards
            document.getElementById('total-boilers').textContent = data.system_stats.total_boilers;
            document.getElementById('operational-boilers').textContent = data.system_stats.operational;
            document.getElementById('warning-boilers').textContent = data.system_stats.warning;
            document.getElementById('avg-efficiency').textContent = data.system_stats.avg_efficiency + '%';

            // Update boiler status table with responsive rendering
            const tableBody = document.getElementById('boiler-status-table');
            tableBody.innerHTML = '';
            
            data.boilers.forEach(boiler => {
                const statusClass = boiler.status === 'operational' ? 'status-operational' : 
                                  boiler.status === 'warning' ? 'status-warning' : 'status-critical';
                const statusIcon = boiler.status === 'operational' ? 'fa-check-circle' :
                                 boiler.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
                
                const row = document.createElement('tr');
                
                // Check if mobile view
                const isMobile = window.innerWidth < 576;
                const isTablet = window.innerWidth < 768;
                
                if (isMobile) {
                    // Mobile layout - show only essential info
                    row.innerHTML = `
                        <td><strong>${boiler.name}</strong></td>
                        <td class="${statusClass}">
                            <i class="fas ${statusIcon}"></i> <span class="d-none d-sm-inline">${boiler.status.toUpperCase()}</span>
                        </td>
                        <td class="d-none d-sm-table-cell">${boiler.temperature}°C</td>
                        <td class="d-none d-sm-table-cell">${boiler.efficiency}%</td>
                    `;
                } else {
                    // Desktop/tablet layout - show all info
                    row.innerHTML = `
                        <td><strong>${boiler.name}</strong></td>
                        <td class="${statusClass}">
                            <i class="fas ${statusIcon}"></i> ${boiler.status.toUpperCase()}
                        </td>
                        <td class="d-none d-sm-table-cell">${boiler.temperature}°C</td>
                        <td class="d-none d-md-table-cell">${boiler.pressure} bar</td>
                        <td class="d-none d-lg-table-cell">${boiler.flow_rate} L/min</td>
                        <td class="d-none d-sm-table-cell">${boiler.efficiency}%</td>
                        <td class="d-none d-md-table-cell">${boiler.last_maintenance}</td>
                    `;
                }
                tableBody.appendChild(row);
            });

            // Update alerts with responsive design
            const alertsContainer = document.getElementById('alerts-container');
            alertsContainer.innerHTML = '';
            
            if (data.alerts.length === 0) {
                alertsContainer.innerHTML = '<p class="text-muted text-center mb-0">No active alerts</p>';
            } else {
                data.alerts.forEach(alert => {
                    const alertClass = alert.severity === 'critical' ? 'alert-danger' :
                                     alert.severity === 'warning' ? 'alert-warning' : 'alert-info';
                    const alertIcon = alert.severity === 'critical' ? 'fa-times-circle' :
                                    alert.severity === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
                    
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert ${alertClass} alert-sm mb-2`;
                    alertDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <i class="fas ${alertIcon} me-2 mt-1"></i>
                            <div class="flex-grow-1">
                                <strong class="d-block d-sm-inline">Boiler ${alert.boiler_id}:</strong> 
                                <span class="d-block d-sm-inline">${alert.message}</span>
                                <br><small class="text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
                            </div>
                        </div>
                    `;
                    alertsContainer.appendChild(alertDiv);
                });
            }
        })
        .catch(error => {
            console.error('Error fetching sensor data:', error);
        });
}

function updateHistoricalChart() {
    fetch('/api/historical-data/')
        .then(response => response.json())
        .then(data => {
            const labels = data.data.map(item => {
                const date = new Date(item.timestamp);
                return date.getHours() + ':00';
            });
            
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = data.data.map(item => item.boiler_1_temp);
            temperatureChart.data.datasets[1].data = data.data.map(item => item.boiler_2_temp);
            temperatureChart.data.datasets[2].data = data.data.map(item => item.boiler_3_temp);
            temperatureChart.update();
        })
        .catch(error => {
            console.error('Error fetching historical data:', error);
        });
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    updateDashboard();
    updateHistoricalChart();
    
    // Update every 30 seconds
    setInterval(updateDashboard, 30000);
    setInterval(updateHistoricalChart, 60000);
    
    // Handle window resize for responsive updates
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            // Update chart responsiveness
            if (temperatureChart) {
                temperatureChart.options.scales.x.title.display = window.innerWidth >= 768;
                temperatureChart.options.scales.x.ticks.maxTicksLimit = window.innerWidth < 768 ? 6 : 12;
                temperatureChart.options.plugins.title.display = window.innerWidth >= 768;
                temperatureChart.options.scales.x.ticks.font.size = window.innerWidth < 768 ? 9 : 11;
                temperatureChart.options.scales.y.ticks.font.size = window.innerWidth < 768 ? 9 : 11;
                temperatureChart.options.plugins.legend.labels.font.size = window.innerWidth < 768 ? 10 : 12;
                temperatureChart.update('resize');
            }
            
            // Re-render table for new screen size
            updateDashboard();
        }, 250);
    });
});
</script>
{% endblock %}
